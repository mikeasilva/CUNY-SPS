---
title: "DATA 624 Homework 10"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 4
    code_folding: "show"
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA,
                      message = FALSE, warning = FALSE)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(tidyr)
library(igraph)
library(arules)
library(stats)
```

## Introduction

The assignment is to use R to mine the data for association rules. It should report support, confidence and lift and your top 10 rules by lift.

## Market Basket Analysis

First I will read in the data and explore it a bit by looking at the top 10 items purchased

```{r}
transactions <- read.transactions("GroceryDataSet.csv", sep=",")
itemFrequencyPlot(transactions, topN=10, type="absolute", main="Top 10 Items")
```

Whole milk is the most frequently purchased item.

In order to complete this market basket analysis, I will use the Apriori algorithm. I will print out the top 10 rules with their support, confidence and lift.

```{r}
apriori(transactions, parameter=list(supp=0.001, conf=0.5) , control=list(verbose=FALSE)) %>%
  DATAFRAME() %>%
  arrange(desc(lift)) %>%
  top_n(10) %>%
  kable() %>%
  kable_styling()
```

## Cluster Analysis

I am going to look for item groupings.  I will use a network graph to preform the cluster analysis.  First I will need to create a network graph from the transaction data.  The I will detect the communities in the graph using the Louvain algorthym.

```{r}
temp <- read.csv("GroceryDataSet.csv", header = FALSE) %>%
  mutate(shoper_id = row_number()) %>%
  pivot_longer(-shoper_id) %>%
  filter(value != "") %>%
  select(-name)

louvain_communities <- temp %>%
  rename(to = value, from = shoper_id) %>%
  graph_from_data_frame(directed = FALSE) %>%
  cluster_louvain() %>%
  communities()
```

Now that all customers and items are assigned to one of `r length(louvain_communities)` clusters I will summarize them by naming them the items and giving the count of the shopers in the cluster. 

```{r}
items <- as.character(unique(temp$value))

cluster_df <- data.frame(name = c(NA), members = c(NA)) %>% na.omit()

for (i in 1:length(louvain_communities)){
  cluster_name <- paste0(i,": ")
  cluster_members <- 0
  for (member in louvain_communities[[i]]){
    if (member %in% items){
      cluster_name <- paste0(cluster_name, member, " + ")
    } else {
      cluster_members <- cluster_members + 1
    }
  }
  cluster_name <- substr(cluster_name,1,nchar(cluster_name)-3)
  cluster_df <- rbind(cluster_df, data.frame(name = cluster_name, members = cluster_members))
}

cluster_df %>%
  arrange(desc(members)) %>%
  kable() %>%
  kable_styling()
```
 

